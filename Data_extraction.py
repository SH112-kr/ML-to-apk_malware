from re import L
from androguard.core.bytecodes.apk import APK
from androguard.session import Session
from androguard.core.bytecodes.dvm import DalvikVMFormat
from androguard.misc import AnalyzeAPK
from androguard.core.analysis.analysis import ExternalMethod, StringAnalysis
import hashlib
import os
import csv
import numpy as np


def read_csv(): 
    """퍼미션 카테고리 정보 파싱\ 데이터 csv 읽기"""
    open_data_file = open('C:\\Users\\SSH\\Desktop\\python_code\\python\\Center\\Apk_Malware_Crawler\\android_dataset-v2.csv','r')
    rdr = csv.reader(open_data_file)

    rdr = list(rdr)


    open_data_file.close()

    perm_list = rdr[0]
    return perm_list    #퍼미션 카테고리 정보 파싱


def parse_apk_permission():
    os.chdir('C:\\Users\\SSH\\Desktop\\python_code\\python\\Center\\Apk_Malware_Crawler\\Detected_Sample')
    apkf = APK("2022-8-26-11-13-16_phishingeyes.apk")


    Perm = apkf.get_permissions()
    apk_perm_ext = []

    for i in Perm:
        apk_perm_ext.append(i)
    
    return apk_perm_ext #악성 샘플에 대한 권한 데이터 반환 (리스트)


def get_sample_by_dir(dir):
    """샘플 디렉토리 주소 반환"""
    sample_list = []
    sample_apk_folder = os.listdir(dir)
    for i in sample_apk_folder:
        sample_list.append(dir+"\\"+i)
    
    return sample_list # 샘플이 존재하는 주소지 정보 반호나 (리스트)

def compare_perm_apk(perm_list):
    """ apk 권한이 존재하는지 확인 이후 포맷팅 리턴"""
    apk_perm_check = [] #apk 권한 체크 1행 이후 기입할 포맷팅 정보 
    apk_perm_ext = parse_apk_permission()
    apk_perm_ext2 = []
    for apk_perm in apk_perm_ext:
        if apk_perm in perm_list:
            apk_perm_ext2.append(apk_perm)
            

    for i in perm_list:
        if i in apk_perm_ext2:
            apk_perm_check.append(1)
        else:
            apk_perm_check.append(0)


    return apk_perm_check   #권한 맵핑 정보 반환 (리스트)
        

def create_np(perm_list):
    """ 다중 배열 기입을 위해 다중 리스트 생성 """
    perm_list_number = len(perm_list)
    arr = np.zeros((0,perm_list_number),int)

    return arr


"""
4. 반복문을 통해 비교하여 존재하는 퍼미션 1로 맵핑
"""

sample_apk_folder = get_sample_by_dir("C:\\Users\\SSH\\Desktop\\python_code\\python\\Center\\Apk_Malware_Crawler")
perm_list = read_csv()
apk_perm_ext = compare_perm_apk(perm_list)
row_list = perm_list
np_box = create_np(perm_list) # np box 생성
np_box = np.append(np_box, np.array([row_list]),axis=0)
np_box = np.append(np_box, np.array([apk_perm_ext]),axis=0)
print(np_box)
#for apk_list in sample_apk_folder:
#    parse_apk_permission(apk_list)
np_box = np.append(np_box, np.array([apk_perm_ext]),axis=0)
print(np_box)

import pandas as pd
pd.DataFrame(np_box).to_csv("test.csv")








